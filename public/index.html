<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>VibeFlow</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #fff;
    }

    .container {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      display: flex;
      flex-direction: column;
      background-color: #1e1e1e;
      width: 80px;
      padding: 1rem 0;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      align-items: center;
      z-index: 999;
    }

    .sidebar .logo {
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 2rem;
      color: #ff4081;
    }

    .sidebar a {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 0.8rem 0;
      text-decoration: none;
      color: #ccc;
      transition: color 0.3s;
      font-size: 0.9rem;
    }

    .sidebar a.active,
    .sidebar a:hover {
      color: #ff4081;
    }

    .sidebar a span {
      display: block;
    }

    /* Video Central */
    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* Responsivo: menu inferior em telas pequenas */
    @media (max-width: 768px) {
      .sidebar {
        flex-direction: row;
        justify-content: space-around;
        width: 100%;
        height: 60px;
        bottom: 0;
        top: auto;
        padding: 0;
      }

      .sidebar .logo {
        display: none;
      }

      .sidebar a span:last-child {
        display: none; /* Oculta texto, deixa s√≥ o √≠cone */
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="sidebar">
      <div class="logo">VibeFlow</div>
      <a href="/" class="active"><span>üè†</span><span>Lobby</span></a>
      <a href="/perfil"><span>üë§</span><span>Perfil</span></a>
      <a href="/login"><span>üîê</span><span>Login</span></a>
      <a href="/registro"><span>üìù</span><span>Registro</span></a>
      <a href="#"><span>‚ãØ</span><span>Mais</span></a>
    </div>

    <!-- Conte√∫do principal pode ir aqui -->
<div class="video-wrapper">
      <video id="videoPlayer" autoplay playsinline>
        <source src="" type="video/mp4" />
      </video>
      <button id="playPauseBtn" class="play-pause-btn">‚è∏Ô∏è</button>
      <div class="overlay">
        <div class="header">
          <div class="user">
            <img src="https://i.pinimg.com/736x/e2/ea/0e/e2ea0e96d8001b581f4be4d19585f390.jpg" alt="User" onclick="goToProfile(localStorage.getItem('currentUser'))" />
          </div>
          <div class="search-bar">
            <input type="text" id="searchInput" placeholder="Pesquisar v√≠deos..." oninput="searchVideos()" onkeypress="handleSearchEnter(event)" />
            <div id="searchSuggestions" class="search-suggestions"></div>
            <div id="searchResults" class="search-results"></div>
          </div>
        </div>
        <div class="content">
          <div class="info">
            <div class="caption-wrapper" id="captionWrapper">
              <p id="videoCaption"></p>
              <span id="seeMore" class="see-more" style="display: none;">Ver mais...</span>
            </div>
            <div class="music" id="videoMusic"></div>
          </div>
          <div class="actions">
            <button id="likeBtn">‚ù§Ô∏è</button>
            <span id="likeCount">0</span>
            <button id="commentBtn">üí¨</button>
            <span id="commentCount">0</span>
            <a id="downloadBtn" class="download-btn">‚¨áÔ∏è</a>
            <span>Baixar</span>
          </div>
        </div>
      </div>
      <div class="comments-section" id="commentsSection">
        <div id="commentsList"></div>
        <div class="comment-input">
          <input type="text" id="newComment" placeholder="Adicione um coment√°rio..." />
          <button onclick="addComment()">Enviar</button>
        </div>
      </div>
    </div>
    <div id="feedback" class="feedback">Sem mais v√≠deos dos outros usu√°rios</div>
  </div>

  <script>
    let videos = [];
    let currentVideoIndex = 0;
    let currentUser = localStorage.getItem('currentUser');
    let otherUsersVideosCount = 0;
    let isFeedbackVisible = false;
    const baseUrl = window.location.origin;

    if (!currentUser) {
      window.location.href = '/login';
    }

    // Fun√ß√£o para embaralhar array (Fisher-Yates Shuffle)
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
      return array;
    }

    async function fetchFeed() {
      try {
        const res = await fetch(`${baseUrl}/api/feed`);
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status} - ${await res.text()}`);
        const data = await res.json();
        console.log('Dados recebidos do feed:', data);
        return data.resultado || [];
      } catch (err) {
        console.error('Erro ao carregar feed:', err.message);
        return [];
      }
    }

    async function fetchVideos(query) {
      try {
        console.log(`Buscando v√≠deos com query: ${query}`);
        const res = await fetch(`${baseUrl}/api/videos`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query: query })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status} - ${await res.text()}`);
        const data = await res.json();
        console.log('Dados recebidos da API:', data);
        return data.resultado
          ? data.resultado.filter(v => v.no_watermark)
          : [];
      } catch (err) {
        console.error('Erro ao carregar v√≠deos:', err.message);
        return [];
      }
    }

    async function loadInitialVideos() {
      const feedVideos = await fetchFeed();
      if (feedVideos.length > 0) {
        videos = shuffleArray(feedVideos);
        otherUsersVideosCount = videos.filter(v => v.username !== currentUser).length;
      } else {
        const queries = [
          'anime', 'phonk', 'v√≠deos aleat√≥rios portugues', 's√©ries', 'memes', 'a√ß√£o', 'drama',
          'com√©dia', 'terror', 'romance', 'trailers', 'motiva√ß√£o', 'carros', 'natureza',
          'jogos', 'FPS', 'valorant', 'fortnite', 'pubg', 'edit', 'cinema', 'curtas',
          'tiktok viral', 'dan√ßa', 'incr√≠vel', 'fails', '√©pico', 'kpop', 'musica', 'instrumental',
          'videoclipes', 'rap', 'lofi', 'filmes', 'retro', 'anos 2000', 'hist√≥ria', 'anime triste',
          'a√ß√£o intensa', 'opening anime', 'ending anime'
        ];
        const randomQuery = queries[Math.floor(Math.random() * queries.length)];
        videos = await fetchVideos(randomQuery);
        if (videos.length === 0) {
          videos = [
            { no_watermark: 'https://www.w3schools.com/html/mov_bbb.mp4', title: 'V√≠deo de Fallback 1', music: { title: 'M√∫sica de Fallback 1' }, username: 'outroUsuario' },
            { no_watermark: 'https://www.w3schools.com/html/mov_bbb.mp4', title: 'V√≠deo de Fallback 2', music: { title: 'M√∫sica de Fallback 2' }, username: 'outroUsuario' }
          ];
        }
        videos = shuffleArray(videos);
        otherUsersVideosCount = videos.filter(v => v.username !== currentUser).length;
      }
      loadVideo(currentVideoIndex);
    }

    async function loadVideo(index) {
      const video = videos[index];
      if (!video || !video.no_watermark) {
        console.error('V√≠deo inv√°lido ou n√£o encontrado:', video);
        return;
      }

      const videoEl = document.getElementById('videoPlayer');
      const source = videoEl.querySelector('source');
      source.src = video.no_watermark;
      videoEl.load();
      videoEl.play();

      const caption = video.title || '';
      const captionEl = document.getElementById('videoCaption');
      const captionWrapper = document.getElementById('captionWrapper');
      const seeMoreBtn = document.getElementById('seeMore');
      const commentsSection = document.getElementById('commentsSection');
      const commentsList = document.getElementById('commentsList');

      captionEl.textContent = caption;
      document.getElementById('videoMusic').textContent = video.music.title || 'M√∫sica Desconhecida';

      try {
        const res = await fetch(`${baseUrl}/api/comments`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId: video.no_watermark })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        const data = await res.json();
        commentsList.innerHTML = '';
        if (data.comentarios && data.comentarios.length > 0) {
          data.comentarios.forEach(comment => {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment';
            const avatarSrc = comment.avatar || 'https://via.placeholder.com/30';
            commentDiv.innerHTML = `<img src="${avatarSrc}" alt="User" /><p onclick="goToProfile('${comment.user}')">${comment.user}: ${comment.text}</p>`;
            commentsList.appendChild(commentDiv);
          });
          document.getElementById('commentCount').textContent = data.comentarios.length;
        } else {
          document.getElementById('commentCount').textContent = '0';
        }

        const likeRes = await fetch(`${baseUrl}/api/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId: video.no_watermark, username: currentUser })
        });
        if (!likeRes.ok) throw new Error(`Erro HTTP: ${likeRes.status}`);
        const likeData = await likeRes.json();
        document.getElementById('likeCount').textContent = likeData.total || 0;
      } catch (err) {
        console.error('Erro ao carregar coment√°rios ou curtidas:', err);
        document.getElementById('commentCount').textContent = '0';
        document.getElementById('likeCount').textContent = '0';
      }

      captionWrapper.classList.remove('expanded');
      seeMoreBtn.style.display = 'none';
      seeMoreBtn.textContent = 'Ver mais...';
      commentsSection.style.display = 'none';

      setTimeout(() => {
        if (captionEl.offsetHeight > 60) {
          seeMoreBtn.style.display = 'block';
        }
      }, 0);
    }

    async function nextVideo() {
      const feedback = document.getElementById('feedback');
      const otherUsersVideos = videos.filter(v => v.username !== currentUser);

      if (isFeedbackVisible) {
        const queries = [
          'anime', 'phonk', 'v√≠deos aleat√≥rios portugues', 's√©ries', 'memes', 'a√ß√£o', 'drama',
          'com√©dia', 'terror', 'romance', 'trailers', 'motiva√ß√£o', 'carros', 'natureza',
          'jogos', 'FPS', 'valorant', 'fortnite', 'pubg', 'edit', 'cinema', 'curtas',
          'tiktok viral', 'dan√ßa', 'incr√≠vel', 'fails', '√©pico', 'kpop', 'musica', 'instrumental',
          'videoclipes', 'rap', 'lofi', 'filmes', 'retro', 'anos 2000', 'hist√≥ria', 'anime triste',
          'a√ß√£o intensa', 'opening anime', 'ending anime'
        ];
        const randomQuery = queries[Math.floor(Math.random() * queries.length)];
        const newVideos = await fetchVideos(randomQuery);
        
        if (newVideos.length > 0) {
          videos = shuffleArray(newVideos);
          currentVideoIndex = 0;
          otherUsersVideosCount = videos.filter(v => v.username !== currentUser).length;
          feedback.style.display = 'none';
          isFeedbackVisible = false;
          loadVideo(currentVideoIndex);
        } else {
          feedback.textContent = 'N√£o foi poss√≠vel carregar novos v√≠deos. Tente novamente.';
        }
        return;
      }

      if (currentVideoIndex + 1 >= otherUsersVideos.length) {
        isFeedbackVisible = true;
        feedback.style.display = 'block';
        document.getElementById('videoPlayer').pause();
      } else {
        currentVideoIndex++;
        feedback.style.display = 'none';
        isFeedbackVisible = false;
        console.log('Pr√≥ximo v√≠deo:', currentVideoIndex);
        loadVideo(currentVideoIndex);
      }
    }

    function prevVideo() {
      const feedback = document.getElementById('feedback');
      if (currentVideoIndex > 0) {
        currentVideoIndex--;
        feedback.style.display = 'none';
        isFeedbackVisible = false;
        console.log('V√≠deo anterior:', currentVideoIndex);
        loadVideo(currentVideoIndex);
      }
    }

    function goToProfile(username) {
      if (username && username !== currentUser) {
        console.log('Redirecionando para o perfil de:', username);
        localStorage.setItem('viewedUser', username);
        window.location.href = '/perfil';
      } else {
        console.log('N√£o redirecionou: usu√°rio inv√°lido ou √© o currentUser');
      }
    }

    async function addComment() {
      const video = videos[currentVideoIndex];
      const commentText = document.getElementById('newComment').value;
      if (commentText && video && video.no_watermark) {
        const res = await fetch(`${baseUrl}/api/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId: video.no_watermark, username: currentUser, text: commentText })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        const data = await res.json();
        document.getElementById('commentCount').textContent = data.comentarios.length;
        document.getElementById('newComment').value = '';
        loadVideo(currentVideoIndex);
      }
    }

    async function searchVideos() {
      const query = document.getElementById('searchInput').value.trim();
      const searchSuggestions = document.getElementById('searchSuggestions');
      const searchResults = document.getElementById('searchResults');

      if (query.length < 2) {
        searchSuggestions.classList.remove('active');
        searchResults.classList.remove('active');
        return;
      }

      // Exibir sugest√µes fixas de pesquisa
      const suggestions = [
        'Anime - Dublado', '4K Anime Edits', 'Animes - Edits', 'animeedits', 'hunter x hunter',
        'animes romance', 'Animes De Luta', 'Anime - Melhores Edits', 'Top 10 Dos Melhores Animes'
      ];
      searchSuggestions.innerHTML = '';
      suggestions.forEach(suggestion => {
        const div = document.createElement('div');
        div.textContent = suggestion;
        div.onclick = () => {
          window.location.href = `search.html?query=${encodeURIComponent(suggestion)}`;
        };
        searchSuggestions.appendChild(div);
      });
      searchSuggestions.classList.add('active');
    }

    function handleSearchEnter(event) {
      if (event.key === 'Enter') {
        const query = document.getElementById('searchInput').value.trim();
        const searchSuggestions = document.getElementById('searchSuggestions');
        if (searchSuggestions.classList.contains('active') && searchSuggestions.children.length > 0) {
          const firstSuggestion = searchSuggestions.children[0].textContent;
          window.location.href = `search.html?query=${encodeURIComponent(firstSuggestion)}`;
        } else if (query) {
          window.location.href = `search.html?query=${encodeURIComponent(query)}`;
        }
        searchSuggestions.classList.remove('active');
      }
    }

    async function searchUsers() {
      const query = document.getElementById('searchInput').value;
      const searchResults = document.getElementById('searchResults');
      if (query.length < 2) {
        searchResults.classList.remove('active');
        return;
      }

      try {
        const res = await fetch(`${baseUrl}/api/search/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        const data = await res.json();
        console.log('Resultados da pesquisa:', data);
        searchResults.innerHTML = '';
        if (data.users && data.users.length > 0) {
          data.users.forEach(user => {
            const div = document.createElement('div');
            div.textContent = user.username;
            div.onclick = () => {
              console.log('Clicou no usu√°rio:', user.username);
              goToProfile(user.username);
              searchResults.classList.remove('active');
              document.getElementById('searchInput').value = '';
            };
            searchResults.appendChild(div);
          });
          searchResults.classList.add('active');
        } else {
          const div = document.createElement('div');
          div.textContent = 'Nenhum usu√°rio encontrado';
          searchResults.appendChild(div);
          searchResults.classList.add('active');
        }
      } catch (err) {
        console.error('Erro ao pesquisar usu√°rios:', err);
        searchResults.innerHTML = '<div>Erro ao buscar usu√°rios</div>';
        searchResults.classList.add('active');
      }
    }

    const videoPlayer = document.getElementById('videoPlayer');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const captionWrapper = document.getElementById('captionWrapper');
    const seeMoreBtn = document.getElementById('seeMore');
    const commentBtn = document.getElementById('commentBtn');
    const commentsSection = document.getElementById('commentsSection');

    videoPlayer.addEventListener('click', () => {
      if (videoPlayer.paused) {
        videoPlayer.play();
        playPauseBtn.textContent = '‚è∏Ô∏è';
      } else {
        videoPlayer.pause();
        playPauseBtn.textContent = '‚ñ∂Ô∏è';
      }
      playPauseBtn.classList.add('visible');
      setTimeout(() => playPauseBtn.classList.remove('visible'), 1000);
    });

    playPauseBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      if (videoPlayer.paused) {
        videoPlayer.play();
        playPauseBtn.textContent = '‚è∏Ô∏è';
      } else {
        videoPlayer.pause();
        playPauseBtn.textContent = '‚ñ∂Ô∏è';
      }
    });

    seeMoreBtn.addEventListener('click', () => {
      if (captionWrapper.classList.contains('expanded')) {
        captionWrapper.classList.remove('expanded');
        seeMoreBtn.textContent = 'Ver mais...';
      } else {
        captionWrapper.classList.add('expanded');
        seeMoreBtn.textContent = 'Ver menos';
      }
    });

    commentBtn.addEventListener('click', () => {
      commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
    });

    document.getElementById('likeBtn').addEventListener('click', async () => {
      const video = videos[currentVideoIndex];
      if (video && video.no_watermark) {
        try {
          const res = await fetch(`${baseUrl}/api/like`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ videoId: video.no_watermark, username: currentUser })
          });
          if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
          const data = await res.json();
          document.getElementById('likeCount').textContent = data.total || 0;
        } catch (err) {
          console.error('Erro ao curtir:', err);
          alert('Erro ao registrar a curtida. Verifique o console para mais detalhes.');
        }
      }
    });

    document.getElementById('downloadBtn').addEventListener('click', async () => {
      const video = videos[currentVideoIndex];
      if (video && video.no_watermark) {
        try {
          const response = await fetch(video.no_watermark);
          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `video_${currentVideoIndex + 1}.mp4`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (err) {
          console.error('Erro ao baixar o v√≠deo:', err);
          alert('N√£o foi poss√≠vel baixar o v√≠deo. Tente novamente.');
        }
      }
    });

    let startY = null;
    document.addEventListener('touchstart', e => {
      startY = e.touches[0].clientY;
    });
    document.addEventListener('touchend', e => {
      if (startY === null) return;
      const endY = e.changedTouches[0].clientY;
      const diff = startY - endY;
      console.log('Deslizamento detectado:', diff);
      if (Math.abs(diff) > 30) {
        if (diff > 0) nextVideo();
        else prevVideo();
      }
      startY = null;
    });

    document.addEventListener('wheel', e => {
      console.log('Rolagem detectada:', e.deltaY);
      if (e.deltaY > 0) nextVideo();
      else prevVideo();
    });

    loadInitialVideos();
  </script>
</body>
</html>
