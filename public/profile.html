<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
  <title>VibeFlow - Perfil</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
    }
    body {
      min-height: 100vh;
      background: #000;
      color: #fff;
      overflow-y: auto;
      padding: 20px;
    }
    .profile-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 20px;
    }
    .profile-header img {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-right: 20px;
      border: 2px solid #ff4545;
    }
    .profile-header .user-info {
      flex-grow: 1;
    }
    .profile-header h2 {
      font-size: 24px;
      color: #fff;
      margin-bottom: 5px;
    }
    .profile-header p {
      font-size: 14px;
      color: #ff8c8c;
      margin-bottom: 10px;
    }
    .profile-stats {
      display: flex;
      gap: 20px;
      margin-bottom: 20px;
    }
    .profile-stats span {
      font-size: 16px;
      color: #fff;
    }
    .profile-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .profile-actions button {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #ff4545;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .profile-actions button:hover {
      background: #ff6b6b;
    }
    .profile-edit input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #fff;
      font-size: 14px;
    }
    .profile-edit button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #ff4545;
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .profile-edit button:hover {
      background: #ff6b6b;
    }
    .upload-section {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 20px;
      padding: 10px;
      background: #333;
      border-radius: 5px;
    }
    .upload-section input[type="text"] {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #444;
      color: #fff;
      font-size: 14px;
    }
    .upload-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 5px;
      background: #ff4545;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .upload-btn:hover {
      background: #ff6b6b;
    }
    #uploadInput {
      display: none;
    }
    .upload-status {
      font-size: 14px;
      color: #ff8c8c;
    }
    .user-videos {
      margin-top: 20px;
    }
    .user-videos h4 {
      font-size: 18px;
      color: #ff4545;
      margin-bottom: 10px;
    }
    .videos-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 10px;
    }
    .video-item {
      position: relative;
      overflow: hidden;
      border-radius: 5px;
      cursor: pointer;
    }
    .video-item video {
      width: 100%;
      height: 300px;
      object-fit: cover;
    }
    .video-info {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      padding: 10px;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 14px;
    }
    .video-info p {
      margin: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .video-filters {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
    }
    .video-filters button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.3s;
    }
    .video-filters button:hover {
      background: #444;
    }
    .video-filters .active {
      background: #ff4545;
    }

    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 1000;
      overflow-y: auto;
    }
    .modal-content {
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .modal-video {
      display: flex;
      max-width: 1200px;
      width: 100%;
    }
    .modal-video video {
      width: 70%;
      height: auto;
      max-height: 80vh;
      border-radius: 5px;
    }
    .modal-details {
      width: 30%;
      padding: 20px;
      background: #111;
      border-radius: 5px;
      margin-left: 20px;
    }
    .modal-details h3 {
      font-size: 18px;
      color: #fff;
      margin-bottom: 10px;
    }
    .modal-details p {
      font-size: 14px;
      color: #ff8c8c;
      margin-bottom: 10px;
    }
    .modal-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    .modal-actions button {
      padding: 10px;
      border: none;
      border-radius: 5px;
      background: #ff4545;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .modal-actions button:hover {
      background: #ff6b6b;
    }
    .modal-actions span {
      font-size: 14px;
      color: #fff;
    }
    .modal-comments {
      margin-top: 10px;
    }
    .modal-comment {
      display: flex;
      flex-direction: column;
      margin-bottom: 10px;
    }
    .modal-comment p {
      font-size: 14px;
      color: #fff;
    }
    .modal-comment-form {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    .modal-comment-form input {
      flex-grow: 1;
      padding: 5px;
      border: none;
      border-radius: 5px;
      background: #333;
      color: #fff;
      font-size: 14px;
    }
    .modal-comment-form button {
      padding: 5px 10px;
      border: none;
      border-radius: 5px;
      background: #ff4545;
      color: #fff;
      font-size: 14px;
      cursor: pointer;
    }
    .modal-comment-form button:hover {
      background: #ff6b6b;
    }
    .close-modal {
      position: absolute;
      top: 20px;
      right: 20px;
      font-size: 24px;
      color: #fff;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      .profile-header {
        flex-direction: column;
        text-align: center;
      }
      .profile-header img {
        margin-right: 0;
        margin-bottom: 10px;
      }
      .profile-stats, .profile-actions {
        flex-direction: column;
        gap: 10px;
      }
      .videos-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
      .video-item video {
        height: 200px;
      }
      .modal-video {
        flex-direction: column;
      }
      .modal-video video {
        width: 100%;
        max-height: 50vh;
      }
      .modal-details {
        width: 100%;
        margin-left: 0;
        margin-top: 20px;
      }
    }
  </style>
</head>
<body>
  <div class="profile-container">
    <div class="profile-header">
      <img id="profileAvatar" src="https://via.placeholder.com/80" alt="Avatar" />
      <div class="user-info">
        <h2 id="profileUsername"></h2>
        <p id="profileBio">Sem bio</p>
      </div>
    </div>
    <div class="profile-stats">
      <span id="seguindoCount">0 Seguindo</span>
      <span id="seguidoresCount">0 Seguidores</span>
      <span id="curtidasCount">0 Curtidas</span>
    </div>
    <div class="profile-actions">
      <button id="followBtn" onclick="toggleFollow()">Seguir</button>
      <button onclick="editProfile()">Editar Perfil</button>
      <button onclick="logout()">Sair</button>
    </div>
    <div class="profile-edit" style="display: none;">
      <input type="text" id="bioInput" placeholder="Atualizar Bio" />
      <input type="text" id="avatarInput" placeholder="URL do Avatar" />
      <button onclick="updateProfile()">Salvar Perfil</button>
    </div>
    <div class="upload-section">
      <input type="text" id="captionInput" placeholder="Digite uma legenda para o vídeo" />
      <div style="display: flex; align-items: center; gap: 10px;">
        <button class="upload-btn" onclick="document.getElementById('uploadInput').click()">
          <span>⬆️ Enviar Vídeo</span>
        </button>
        <span class="upload-status" id="uploadStatus"></span>
        <input type="file" id="uploadInput" accept="video/mp4,video/webm,video/ogg" />
      </div>
    </div>
    <div class="user-videos">
      <h4>Meus Vídeos</h4>
      <div class="video-filters">
        <button class="active">Mais recentes</button>
        <button>Popular</button>
        <button>Mais antigos</button>
      </div>
      <div id="userVideos" class="videos-grid"></div>
    </div>
  </div>

  <!-- Modal -->
  <div id="videoModal" class="modal">
    <span class="close-modal" onclick="closeModal()">×</span>
    <div class="modal-content">
      <div class="modal-video">
        <video id="modalVideo" controls></video>
        <div class="modal-details">
          <h3 id="modalUsername"></h3>
          <p id="modalCaption"></p>
          <p id="modalMusic">Música: Música Desconhecida</p>
          <div class="modal-actions">
            <button id="likeBtn">Curtir</button>
            <span id="likeCount">0 curtidas</span>
          </div>
          <div class="modal-comments">
            <div id="commentsList"></div>
            <div class="modal-comment-form">
              <input type="text" id="commentInput" placeholder="Adicione um comentário..." />
              <button onclick="addComment()">Publicar</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentUser = localStorage.getItem('currentUser');
    const urlParams = new URLSearchParams(window.location.search);
    let viewedUser = urlParams.get('viewedUser') || currentUser;
    const baseUrl = window.location.origin;
    let isEditing = false;

    if (!currentUser) {
      window.location.href = '/login';
    } else {
      document.getElementById('profileUsername').textContent = viewedUser;
    }

    async function loadProfile() {
      try {
        // Carregar dados do perfil
        const userRes = await fetch(`${baseUrl}/api/user/${viewedUser}`);
        if (!userRes.ok) throw new Error(`Erro HTTP: ${userRes.status}`);
        const userData = await userRes.json();
        if (userData.profile) {
          document.getElementById('profileBio').textContent = userData.profile.bio || 'Sem bio';
          document.getElementById('profileAvatar').src = userData.profile.avatar || 'https://via.placeholder.com/80';
          document.getElementById('seguindoCount').textContent = `${userData.stats.seguindo} Seguindo`;
          document.getElementById('seguidoresCount').textContent = `${userData.stats.seguidores} Seguidores`;
          document.getElementById('curtidasCount').textContent = `${userData.stats.curtidas} Curtidas`;

          const followBtn = document.getElementById('followBtn');
          if (userData.profile.seguidores.includes(currentUser)) {
            followBtn.textContent = 'Parar de Seguir';
          } else {
            followBtn.textContent = 'Seguir';
          }
          if (viewedUser === currentUser) {
            followBtn.style.display = 'none';
          }
        }

        // Carregar vídeos do usuário
        const videosRes = await fetch(`${baseUrl}/api/user/${viewedUser}/videos`);
        if (!videosRes.ok) throw new Error(`Erro HTTP: ${videosRes.status}`);
        const videosData = await videosRes.json();
        const userVideos = document.getElementById('userVideos');
        userVideos.innerHTML = '';

        if (videosData.videos && videosData.videos.length > 0) {
          for (const video of videosData.videos) {
            const videoUrl = typeof video === 'string' ? video : video.url;
            const caption = typeof video === 'object' && video.caption ? video.caption : 'Sem legenda';
            const videoId = video.id || Date.now().toString();

            const videoItem = document.createElement('div');
            videoItem.className = 'video-item';
            videoItem.onclick = () => openModal(videoUrl, caption, videoId, viewedUser);

            const videoEl = document.createElement('video');
            videoEl.src = videoUrl;
            videoEl.controls = false;

            const videoInfo = document.createElement('div');
            videoInfo.className = 'video-info';
            videoInfo.innerHTML = `<p>${caption}</p>`;

            videoItem.appendChild(videoEl);
            videoItem.appendChild(videoInfo);
            userVideos.appendChild(videoItem);
          }
        } else {
          userVideos.innerHTML = '<p>Nenhum vídeo encontrado.</p>';
        }
      } catch (err) {
        console.error('Erro ao carregar perfil:', err);
        alert(`Erro ao carregar perfil: ${err.message}`);
      }
    }

    function openModal(videoUrl, caption, videoId, username) {
      const modal = document.getElementById('videoModal');
      const modalVideo = document.getElementById('modalVideo');
      const modalUsername = document.getElementById('modalUsername');
      const modalCaption = document.getElementById('modalCaption');
      const likeBtn = document.getElementById('likeBtn');
      const likeCount = document.getElementById('likeCount');
      const commentsList = document.getElementById('commentsList');

      modalVideo.src = videoUrl;
      modalUsername.textContent = username;
      modalCaption.textContent = caption;

      // Carregar curtidas
      fetch(`${baseUrl}/api/like`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ videoId, username: currentUser })
      })
        .then(res => res.json())
        .then(data => {
          if (data && data.total !== undefined) {
            likeCount.textContent = `${data.total} curtidas`;
          } else {
            console.error('Resposta inválida do servidor para curtidas:', data);
            likeCount.textContent = '0 curtidas';
          }
        })
        .catch(err => console.error('Erro ao carregar curtidas:', err));

      likeBtn.onclick = () => {
        fetch(`${baseUrl}/api/like`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, username: currentUser })
        })
          .then(res => res.json())
          .then(data => {
            if (data && data.total !== undefined) {
              likeCount.textContent = `${data.total} curtidas`;
              alert('Vídeo curtido com sucesso!');
            } else {
              console.error('Resposta inválida do servidor para curtida:', data);
            }
          })
          .catch(err => {
            console.error('Erro ao curtir:', err);
            alert('Erro ao curtir o vídeo.');
          });
      };

      // Carregar comentários
      fetch(`${baseUrl}/api/comments`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ videoId })
      })
        .then(res => res.json())
        .then(data => {
          commentsList.innerHTML = '';
          if (data.comentarios && data.comentarios.length > 0) {
            data.comentarios.forEach(comment => {
              const commentDiv = document.createElement('div');
              commentDiv.className = 'modal-comment';
              commentDiv.innerHTML = `<p><strong>${comment.user}:</strong> ${comment.text}</p>`;
              commentsList.appendChild(commentDiv);
            });
          } else {
            commentsList.innerHTML = '<p>Seja o primeiro a comentar</p>';
          }
        })
        .catch(err => console.error('Erro ao carregar comentários:', err));

      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('videoModal');
      const modalVideo = document.getElementById('modalVideo');
      modal.style.display = 'none';
      modalVideo.src = '';
    }

    function addComment() {
      const videoId = document.getElementById('modalVideo').src.split('id=')[1] || Date.now().toString();
      const text = document.getElementById('commentInput').value;
      if (text) {
        fetch(`${baseUrl}/api/comment`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ videoId, username: currentUser, text })
        })
          .then(res => {
            if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
            return res.json();
          })
          .then(data => {
            if (data && data.comentarios) {
              const commentsList = document.getElementById('commentsList');
              commentsList.innerHTML = '';
              data.comentarios.forEach(comment => {
                const commentDiv = document.createElement('div');
                commentDiv.className = 'modal-comment';
                commentDiv.innerHTML = `<p><strong>${comment.user}:</strong> ${comment.text}</p>`;
                commentsList.appendChild(commentDiv);
              });
              document.getElementById('commentInput').value = '';
              alert('Comentário salvo com sucesso!');
            } else {
              console.error('Resposta inválida do servidor para comentário:', data);
            }
          })
          .catch(err => {
            console.error('Erro ao adicionar comentário:', err);
            alert('Erro ao salvar o comentário.');
          });
      }
    }

    async function toggleFollow() {
      const followBtn = document.getElementById('followBtn');
      const isFollowing = followBtn.textContent === 'Parar de Seguir';
      const endpoint = isFollowing ? '/api/unfollow' : '/api/follow';

      try {
        const res = await fetch(`${baseUrl}${endpoint}`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: currentUser, targetUser: viewedUser })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        loadProfile();
      } catch (err) {
        console.error('Erro ao seguir/parar de seguir:', err);
        alert(`Erro: ${err.message}`);
      }
    }

    function editProfile() {
      const editSection = document.querySelector('.profile-edit');
      if (!isEditing) {
        editSection.style.display = 'block';
        isEditing = true;
      } else {
        editSection.style.display = 'none';
        isEditing = false;
      }
    }

    async function updateProfile() {
      const bio = document.getElementById('bioInput').value;
      const avatar = document.getElementById('avatarInput').value;
      try {
        const res = await fetch(`${baseUrl}/atualizar-perfil`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username: currentUser, bio, avatar })
        });
        if (!res.ok) throw new Error(`Erro HTTP: ${res.status}`);
        const data = await res.json();
        if (data.sucesso) {
          document.getElementById('profileBio').textContent = bio || 'Sem bio';
          document.getElementById('profileAvatar').src = avatar || 'https://via.placeholder.com/80';
          document.querySelector('.profile-edit').style.display = 'none';
          isEditing = false;
          alert('Perfil atualizado com sucesso!');
        } else {
          throw new Error('Resposta do servidor indica falha');
        }
      } catch (err) {
        console.error('Erro ao atualizar perfil:', err);
        alert(`Erro ao atualizar perfil: ${err.message}`);
      }
    }

    document.getElementById('uploadInput').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      const caption = document.getElementById('captionInput').value;
      const uploadStatus = document.getElementById('uploadStatus');
      
      if (file) {
        if (file.size > 100 * 1024 * 1024) {
          uploadStatus.textContent = 'Erro: Arquivo muito grande (máx. 100MB)';
          return;
        }

        uploadStatus.textContent = 'Enviando...';

        const username = localStorage.getItem('currentUser');
        if (!username) {
          uploadStatus.textContent = 'Erro: Usuário não autenticado';
          return;
        }

        const formData = new FormData();
        formData.append('file', file);
        formData.append('username', username);
        formData.append('caption', caption);

        try {
          const res = await fetch(`${baseUrl}/api/upload`, {
            method: 'POST',
            body: formData,
          });

          const data = await res.json();

          if (data.sucesso && data.videoUrl) {
            uploadStatus.textContent = 'Vídeo enviado com sucesso!';
            loadProfile();
          } else {
            uploadStatus.textContent = `Erro: ${data.erro || 'Erro desconhecido'}`;
          }
        } catch (err) {
          uploadStatus.textContent = `Erro ao processar: ${err.message}`;
        }
      } else {
        uploadStatus.textContent = 'Erro: Nenhum arquivo selecionado';
      }
      document.getElementById('uploadInput').value = '';
      document.getElementById('captionInput').value = '';
    });

    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('viewedUser');
      window.location.href = '/login';
    }

    loadProfile();
  </script>
</body>
</html>